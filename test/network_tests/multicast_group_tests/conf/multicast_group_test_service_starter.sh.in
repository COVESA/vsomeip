#!/usr/bin/env bash

# Copyright (C) 2025 Bayerische Motoren Werke Aktiengesellschaft (BMW AG)
# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.

# Configuration to be used by daemon and service.
export VSOMEIP_CONFIGURATION=multicast_group_test_service.json

# Start the routing manager.
export VSOMEIP_APPLICATION_NAME="routingmanagerd-service"
../../../examples/routingmanagerd/routingmanagerd &
DAEMON_PID=$!

# Start the test service.
export VSOMEIP_APPLICATION_NAME="service-sample"
./multicast_group_test_service &
SERVICE_PID=$!

CLIENT_PID=0

# Call other container
if [ ! -z "$USE_LXC_TEST" ]; then
    ssh -tt -i $SANDBOX_ROOT_DIR/commonapi_main/lxc-config/.ssh/mgc_lxc/rsa_key_file.pub -o StrictHostKeyChecking=no root@$LXC_TEST_SLAVE_IP "bash -ci \"set -m; cd \\\$SANDBOX_TARGET_DIR/vsomeip_lib/test/network_tests/multicast_group_tests; ./multicast_group_test_client_starter.sh\"" & CLIENT_PID=$!
elif [ ! -z "$USE_DOCKER" ]; then
    docker exec $DOCKER_IMAGE sh -c "cd $DOCKER_TESTS; ./multicast_group_test_client_starter.sh" & CLIENT_PID=$!
fi

# Whether the test failed.
FAIL=0

# Wait for the client to finish
wait "$CLIENT_PID" || ((FAIL=1))

# Wait for the service to finish.
wait "$SERVICE_PID" || ((FAIL=1))

# Send a termination signal to the routing manager.
kill "$DAEMON_PID"

# Wait for the routing manager to exit.
wait "$DAEMON_PID" || ((FAIL+=1))

# Return the result of the test.
exit "$FAIL"
